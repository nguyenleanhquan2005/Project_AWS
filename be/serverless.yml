service: docqa-aws-bedrock

provider:
  name: aws
  runtime: python3.11
  region: us-east-1
  stage: dev
  timeout: 900
  memorySize: 3008

  environment:
    S3_BUCKET: docqa-uploads-${self:provider.stage}

  apiGateway:
    shouldStartNameWithService: true

  iamRoleStatements:
    - Effect: Allow
      Action:
        - bedrock:InvokeModel
        - bedrock:ListFoundationModels
      Resource:
        - "arn:aws:bedrock:us-east-1::foundation-model/amazon.titan-embed-text-v1"
        - "arn:aws:bedrock:us-east-1::foundation-model/amazon.titan-text-lite-v1"
        - "arn:aws:bedrock:us-east-1::foundation-model/anthropic.claude-instant-v1"

    - Effect: Allow
      Action:
        - s3:*
      Resource:
        - arn:aws:s3:::docqa-uploads-${self:provider.stage}
        - arn:aws:s3:::docqa-uploads-${self:provider.stage}/*

    - Effect: Allow
      Action:
        - dynamodb:*
      Resource:
        - arn:aws:dynamodb:${self:provider.region}:*:table/DocQASessions

    - Effect: Allow
      Action:
        - logs:*
      Resource: "*"

package:
  patterns:
    - "!node_modules/**"
    - "!venv/**"
    - "!__pycache__/**"
    - "!*.pyc"
    - "!package-lock.json"

custom:
  pythonRequirements:
    dockerizePip: false
    useStaticCache: false
    slim: true
    layer: false
    invalidateCaches: true
    pythonBin: py

functions:
  presign:
    handler: handler.presign
    events:
      - http:
          path: presign
          method: post
          cors: true
      - http:
          path: presign
          method: options
          cors: true

  upload:
    handler: handler.upload
    events:
      - http:
          path: upload
          method: post
          cors: true
      - http:
          path: upload
          method: options
          cors: true

  ask:
    handler: handler.ask
    events:
      - http:
          path: ask
          method: post
          cors: true
      - http:
          path: ask
          method: options
          cors: true

resources:
  Resources:
    UploadsBucket:
      Type: AWS::S3::Bucket
      Properties:
        BucketName: docqa-uploads-${self:provider.stage}
        CorsConfiguration:
          CorsRules:
            - AllowedHeaders: ['*']
              AllowedMethods: [GET, PUT, POST, DELETE, HEAD]
              AllowedOrigins: ['*']
              MaxAge: 3000

    WebsiteBucket:
      Type: AWS::S3::Bucket
      Properties:
        BucketName: docqa-website-${self:provider.stage}
        WebsiteConfiguration:
          IndexDocument: index.html
          ErrorDocument: index.html
        PublicAccessBlockConfiguration:
          BlockPublicAcls: false
          BlockPublicPolicy: false
          IgnorePublicAcls: false
          RestrictPublicBuckets: false

    WebsiteBucketPolicy:
      Type: AWS::S3::BucketPolicy
      Properties:
        Bucket: !Ref WebsiteBucket
        PolicyDocument:
          Statement:
            - Effect: Allow
              Principal: '*'
              Action:
                - s3:GetObject
                - s3:ListBucket
              Resource:
                - !Join ['', ['arn:aws:s3:::', !Ref WebsiteBucket]]
                - !Join ['', ['arn:aws:s3:::', !Ref WebsiteBucket, '/*']]

    SessionsTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: DocQASessions
        AttributeDefinitions:
          - AttributeName: session_id
            AttributeType: S
        KeySchema:
          - AttributeName: session_id
            KeyType: HASH
        BillingMode: PAY_PER_REQUEST
        TimeToLiveSpecification:
          AttributeName: expires_at
          Enabled: true

  Outputs:
    WebsiteURL:
      Value: !GetAtt WebsiteBucket.WebsiteURL
      Description: URL của website frontend

    ApiURL:
      Value: !Sub https://${ApiGatewayRestApi}.execute-api.${AWS::Region}.amazonaws.com/${sls:stage}
      Description: URL của API Gateway
